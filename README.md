# TMDB Laravel Application

A Laravel application that fetches movies, series and genres from the TMDB API, stores them in MySQL with multi-language support (PL/EN/DE), and exposes a REST API.

## Stack

- Laravel 12
- PHP 8.4
- MySQL 8
- Redis (queue broker)
- Nginx
- Livewire 4
- spatie/laravel-translatable
- Scramble (API documentation)

## Requirements

- Docker / Podman + docker-compose / podman-compose
- TMDB API token (bearer token) - [https://www.themoviedb.org/settings/api](https://www.themoviedb.org/settings/api)

## Getting Started

1. Clone the repository and navigate to the project directory.

2. Copy the `.env` file and set your TMDB token:

```bash
cp .env.example .env
# Edit .env and set TMDB_API_TOKEN
```

3. Start the containers:

```bash
docker compose up -d
# or: docker-compose up -d / podman-compose up -d
```

Wait for dependencies to install (first run only, ~30s). Check progress with `docker logs -f app`.

4. Generate the application key (if not already generated):

```bash
docker exec app php artisan key:generate
```

5. Run migrations:

```bash
docker exec app php artisan migrate
```

6. Fetch data from TMDB:

```bash
docker exec app php artisan tmdb:fetch
```

The command dispatches a chain of three jobs to the queue:
1. `FetchGenresJob` - fetches all movie and TV genres (in PL, EN, DE)
2. `FetchMoviesJob` - fetches 50 most popular movies (in PL, EN, DE)
3. `FetchSeriesJob` - fetches 10 most popular series (in PL, EN, DE)

Jobs are processed automatically by the `queue-worker` container. Monitor progress with `docker logs -f queue-worker`.

## API Endpoints

| Method | URL | Description |
|--------|-----|-------------|
| GET | `/api/movies` | List movies (paginated) |
| GET | `/api/movies/{id}` | Movie details |
| GET | `/api/series` | List series (paginated) |
| GET | `/api/series/{id}` | Series details |
| GET | `/api/genres` | List genres (paginated) |
| GET | `/api/genres/{id}` | Genre details |

### Pagination

Query string parameters: `?per_page=15&page=1` (default: 15 items per page).

### Multi-language

Set the `Accept-Language` header to `pl`, `en` or `de`. If the header is missing or contains an unsupported language, English (`en`) is used as the default:

```bash
# Default (English)
curl http://localhost:8080/api/movies

# Polish
curl -H "Accept-Language: pl" http://localhost:8080/api/movies

# German
curl -H "Accept-Language: de" http://localhost:8080/api/movies
```

### Example Response

```bash
curl -H "Accept-Language: pl" http://localhost:8080/api/movies?per_page=1
```

```json
{
  "data": [
    {
      "id": 1,
      "tmdb_id": 1236153,
      "title": "90 minut do wolności",
      "overview": "W świecie bliskiej przyszłości wymiar sprawiedliwości...",
      "release_date": "2026-01-20",
      "poster_path": "/pyok1kZJCfyuFapYXzHcy7BLlQa.jpg",
      "vote_average": "6.9",
      "vote_count": 333,
      "popularity": "622.286",
      "genres": [
        { "id": 1, "tmdb_id": 28, "name": "Akcja" },
        { "id": 15, "tmdb_id": 878, "name": "Science Fiction" }
      ]
    }
  ],
  "links": { "first": "...", "last": "...", "prev": null, "next": "..." },
  "meta": { "current_page": 1, "last_page": 50, "per_page": 1, "total": 50 }
}
```

### Error Response

```bash
curl http://localhost:8080/api/movies/99999
```

```json
{
  "message": "Not Found"
}
```

Status: `404 Not Found`

## API Documentation

Interactive API documentation (OpenAPI 3.1.0) is available at:

```
http://localhost:8080/docs/api
```

The documentation is auto-generated by Scramble based on the application code.

## Livewire View

A paginated movie list is available at `http://localhost:8080/movies`.
The display language follows the browser's `Accept-Language` header.

## Tests

```bash
docker exec app php artisan test
```

Tests cover:
- API endpoints (status codes, response structure, pagination)
- `Accept-Language` header handling (PL/EN/DE + fallback)
- 404 responses for non-existent resources
- Artisan command (job dispatching)
- TMDB data fetching jobs (database persistence, genre syncing)

All external HTTP calls (TMDB API) are mocked with `Http::fake()`. Tests use SQLite in-memory and do not require external services or API keys.

## Project Structure

```
app/
├── Console/Commands/FetchTmdbDataCommand.php
├── Contracts/TmdbServiceInterface.php
├── Http/
│   ├── Controllers/
│   │   ├── Api/
│   │   │   ├── GenreController.php
│   │   │   ├── MovieController.php
│   │   │   └── SerieController.php
│   │   └── Controller.php
│   ├── Middleware/
│   │   ├── ForceJsonResponse.php
│   │   └── SetLocaleMiddleware.php
│   └── Resources/
│       ├── GenreResource.php
│       ├── MovieResource.php
│       └── SerieResource.php
├── Jobs/
│   ├── FetchGenresJob.php
│   ├── FetchMoviesJob.php
│   └── FetchSeriesJob.php
├── Livewire/MovieList.php
├── Models/
│   ├── Genre.php
│   ├── Movie.php
│   └── Serie.php
├── Providers/AppServiceProvider.php
└── Services/TmdbService.php
```
